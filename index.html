<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ec4899">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå∏</text></svg>">
    <title>Finanzas de Mam√° üíñ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.7)',
                        glassBorder: 'rgba(255, 255, 255, 0.5)',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            background-attachment: fixed;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .glass-button {
            background: linear-gradient(to right, #ec4899, #f43f5e);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
        }

        .glass-button:hover {
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4);
            transform: translateY(-1px);
        }

        /* Smooth transitions */
        .transition-all-300 {
            transition: all 0.3s ease;
        }
    </style>
</head>

<body class="min-h-screen text-slate-800 pb-20">

    <!-- Navbar Simple -->
    <nav class="glass-panel sticky top-0 z-40 border-b border-white/50 px-4 py-4 mb-6">
        <div class="container mx-auto max-w-3xl flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üå∏</span>
                <h1
                    class="text-xl sm:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-600 to-purple-600">
                    Mis Finanzas
                </h1>
            </div>
            <button id="reset-app-btn" class="text-xs text-slate-400 hover:text-red-500 transition-colors">
                Restablecer App
            </button>
        </div>
    </nav>

    <div class="container mx-auto max-w-3xl px-4 space-y-8">

        <!-- Resumen Principal (Tarjetas) -->
        <section>
            <h2 class="text-lg font-bold text-slate-700 mb-3 flex items-center gap-2">
                üí≥ Estado de Cuentas
            </h2>
            <div id="summary-list" class="grid gap-4 sm:grid-cols-2">
                <!-- Cards generadas por JS -->
            </div>
        </section>

        <!-- Botones de Acci√≥n R√°pida -->
        <section class="grid grid-cols-2 gap-4">
            <button onclick="document.getElementById('expense-section').scrollIntoView({behavior: 'smooth'})"
                class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white transition-all-300 group cursor-pointer">
                <div
                    class="w-12 h-12 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                    üìù
                </div>
                <span class="font-semibold text-slate-700">Registrar Gasto</span>
            </button>
            <button onclick="document.getElementById('import-section').scrollIntoView({behavior: 'smooth'})"
                class="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white transition-all-300 group cursor-pointer">
                <div
                    class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                    üìÇ
                </div>
                <span class="font-semibold text-slate-700">Cargar Estado</span>
            </button>
        </section>

        <!-- Formulario de Registro -->
        <section id="expense-section" class="glass-panel rounded-3xl p-6 sm:p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 to-purple-500"></div>

            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                Nuevo Movimiento
            </h2>

            <form id="expense-form" class="space-y-6">
                <input type="hidden" id="editing-expense-id">

                <!-- Tipo: Gasto vs Ingreso -->
                <div class="flex p-1 bg-slate-100 rounded-xl">
                    <button type="button" id="type-expense"
                        class="flex-1 py-3 rounded-lg font-bold text-sm transition-all shadow-sm bg-white text-pink-600">
                        ‚ûñ Gasto (Cargo)
                    </button>
                    <button type="button" id="type-income"
                        class="flex-1 py-3 rounded-lg font-bold text-sm transition-all text-slate-500 hover:text-slate-700">
                        ‚ûï Ingreso (Abono)
                    </button>
                </div>
                <input type="hidden" id="transaction-type" value="expense">

                <!-- Monto y Moneda -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Monto</label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                            <input type="number" id="amount" placeholder="0.00" step="0.01"
                                class="w-full pl-8 pr-4 py-4 bg-slate-50 border-none rounded-xl text-2xl font-bold text-slate-800 focus:ring-2 focus:ring-pink-500 outline-none"
                                required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Moneda</label>
                        <select id="currency"
                            class="w-full h-[60px] px-2 bg-slate-50 border-none rounded-xl font-bold text-slate-700 focus:ring-2 focus:ring-pink-500 outline-none">
                            <option value="MXN">MXN</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                </div>

                <!-- Descripci√≥n -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">¬øQu√© compraste?</label>
                    <input type="text" id="description" placeholder="Ej: Supermercado, Gasolina..."
                        class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-lg text-slate-800 focus:ring-2 focus:ring-pink-500 outline-none"
                        required>
                </div>

                <!-- M√©todo de Pago -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">M√©todo de Pago</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" data-payment="Efectivo"
                            class="payment-method-btn py-3 px-2 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-all flex flex-col items-center gap-1">
                            <span>üíµ</span> <span class="text-xs">Efectivo</span>
                        </button>
                        <button type="button" data-payment="Tarjeta"
                            class="payment-method-btn py-3 px-2 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-all flex flex-col items-center gap-1">
                            <span>üí≥</span> <span class="text-xs">Tarjeta</span>
                        </button>
                        <button type="button" data-payment="Transferencia"
                            class="payment-method-btn py-3 px-2 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50 transition-all flex flex-col items-center gap-1">
                            <span>üì±</span> <span class="text-xs">Transfer</span>
                        </button>
                    </div>
                    <input type="hidden" id="payment-method">
                </div>

                <!-- Opciones de Tarjeta (Oculto por defecto) -->
                <div id="card-options" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-100 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Selecciona la
                            Tarjeta</label>
                        <div class="grid grid-cols-2 gap-2" id="card-buttons-container">
                            <!-- Botones de tarjeta generados por JS -->
                        </div>
                        <input type="hidden" id="selected-card-info">
                    </div>

                    <div id="installments-section" class="hidden">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Meses Sin Intereses</label>
                        <select id="installments-months"
                            class="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-slate-700 focus:ring-2 focus:ring-pink-500 outline-none">
                            <option value="0">Pago √önico (Sin MSI)</option>
                            <option value="3">3 Meses</option>
                            <option value="6">6 Meses</option>
                            <option value="9">9 Meses</option>
                            <option value="12">12 Meses</option>
                            <option value="18">18 Meses</option>
                        </select>
                    </div>
                </div>

                <!-- Fecha -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                    <input type="date" id="date"
                        class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-slate-800 focus:ring-2 focus:ring-pink-500 outline-none">
                </div>

                <button type="submit"
                    class="w-full glass-button text-white font-bold text-lg py-4 rounded-xl shadow-lg hover:shadow-xl transition-all active:scale-95">
                    Guardar Movimiento
                </button>
            </form>
        </section>

        <!-- Lista de Movimientos -->
        <section class="glass-panel rounded-3xl p-6">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                <div class="flex items-center gap-2 cursor-pointer" onclick="toggleListVisibility()">
                    <h2 class="text-lg font-bold text-slate-700">√öltimos Movimientos</h2>
                    <span id="list-toggle-icon"
                        class="text-slate-400 text-sm transition-transform duration-300">‚ñº</span>
                </div>

                <div class="flex flex-wrap items-center gap-2 sm:gap-3">
                    <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg hover:bg-slate-200 transition-colors cursor-pointer"
                        onclick="toggleSelectAllWrapper()">
                        <input type="checkbox" id="select-all-checkbox"
                            class="w-4 h-4 text-pink-600 rounded focus:ring-pink-500 cursor-pointer">
                        <label class="text-xs font-bold text-slate-600 cursor-pointer select-none">Todo</label>
                    </div>

                    <button id="delete-selected-btn" onclick="deleteSelected()"
                        class="hidden text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded-lg font-bold hover:bg-red-200 transition-colors flex items-center gap-1">
                        <span>üóëÔ∏è</span> (<span id="selected-count">0</span>)
                    </button>

                    <select id="filter-date-select"
                        class="text-sm bg-slate-100 border-none rounded-lg px-2 py-2 text-slate-600 focus:ring-2 focus:ring-pink-500 outline-none max-w-[120px]">
                        <option value="all">üìÖ Todo</option>
                    </select>

                    <select id="filter-card-select"
                        class="text-sm bg-slate-100 border-none rounded-lg px-2 py-2 text-slate-600 focus:ring-2 focus:ring-pink-500 outline-none max-w-[120px]">
                        <option value="all">üí≥ Todo</option>
                    </select>
                </div>
            </div>

            <div id="expenses-list-container"
                class="transition-all duration-500 ease-in-out overflow-hidden max-h-[2000px] opacity-100">
                <div id="expenses-list" class="space-y-3">
                    <!-- Lista generada por JS -->
                </div>
                <div id="empty-state" class="hidden text-center py-12">
                    <p class="text-slate-400">Todo tranquilo por aqu√≠.</p>
                </div>
            </div>
        </section>

        <!-- Importar / Exportar -->
        <section id="import-section" class="glass-panel rounded-3xl p-6 border-l-4 border-blue-500">
            <h2 class="text-lg font-bold text-slate-700 mb-4">Herramientas</h2>

            <div class="grid sm:grid-cols-2 gap-4">
                <!-- Importar -->
                <div class="space-y-3">
                    <p class="text-sm text-slate-500 font-medium">üì• Cargar Estados de Cuenta</p>

                    <!-- Excel -->
                    <label
                        class="flex items-center justify-between w-full p-3 bg-white border border-slate-200 rounded-xl cursor-pointer hover:bg-green-50 hover:border-green-300 transition-all group">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">üìä</span>
                            <span class="text-sm font-bold text-slate-600 group-hover:text-green-600">Subir Excel
                                (.xlsx)</span>
                        </div>
                        <input type="file" id="import-excel-input" accept=".xlsx, .xls" class="hidden">
                    </label>

                    <!-- PDF -->
                    <label
                        class="flex items-center justify-between w-full p-3 bg-white border border-slate-200 rounded-xl cursor-pointer hover:bg-red-50 hover:border-red-300 transition-all group">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">üìÑ</span>
                            <span class="text-sm font-bold text-slate-600 group-hover:text-red-600">Subir PDF
                                (Banco)</span>
                        </div>
                        <input type="file" id="import-pdf-input" accept=".pdf" class="hidden">
                    </label>

                    <button id="download-template-btn"
                        class="w-full text-xs text-blue-500 underline hover:text-blue-700 text-left pl-1">
                        Descargar Plantilla Excel
                    </button>
                </div>

                <!-- Reporte -->
                <div class="space-y-2">
                    <p class="text-sm text-slate-500 font-medium">üì§ Reportes</p>
                    <button id="generate-report-btn"
                        class="w-full p-3 bg-teal-50 border border-teal-200 rounded-xl font-bold text-teal-700 hover:bg-teal-100 transition-all flex items-center justify-center gap-2">
                        <span>üìä</span> Generar Reporte
                    </button>
                </div>

                <!-- Respaldo (Nuevo) -->
                <div class="space-y-2 sm:col-span-2 border-t border-slate-200 pt-4 mt-2">
                    <p class="text-sm text-slate-500 font-medium">üíæ Respaldo y Migraci√≥n</p>
                    <div class="flex gap-3">
                        <button onclick="exportBackup()"
                            class="flex-1 p-3 bg-purple-50 border border-purple-200 rounded-xl font-bold text-purple-700 hover:bg-purple-100 transition-all flex items-center justify-center gap-2">
                            <span>‚¨áÔ∏è</span> Descargar Respaldo
                        </button>
                        <label
                            class="flex-1 p-3 bg-purple-50 border border-purple-200 rounded-xl font-bold text-purple-700 hover:bg-purple-100 transition-all flex items-center justify-center gap-2 cursor-pointer">
                            <span>‚¨ÜÔ∏è</span> Restaurar Respaldo
                            <input type="file" id="restore-input" accept=".json" class="hidden"
                                onchange="restoreBackup(this)">
                        </label>
                    </div>
                    <p class="text-xs text-slate-400 text-center">Usa esto para pasar tus datos de la versi√≥n local a la
                        versi√≥n web.</p>
                </div>
            </div>
            <p id="feedback-msg" class="text-center text-sm font-bold mt-4 hidden"></p>
        </section>

    </div>

    <!-- Modal de Pago -->
    <div id="payment-modal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-3xl mx-auto mb-3">
                    üí∏</div>
                <h3 class="text-xl font-bold text-slate-800">Registrar Pago</h3>
                <p class="text-sm text-slate-500">Abonar a: <b id="modal-card-name" class="text-slate-800"></b></p>
            </div>

            <form id="payment-form" class="space-y-4">
                <input type="hidden" id="modal-card-id">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Monto a
                        Pagar</label>
                    <input type="number" id="payment-amount" placeholder="0.00" step="0.01"
                        class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-2xl font-bold text-slate-800 focus:ring-2 focus:ring-green-500 outline-none"
                        required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                    <input type="date" id="payment-date"
                        class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl text-slate-800 focus:ring-2 focus:ring-green-500 outline-none"
                        required>
                </div>
                <div class="flex gap-3 mt-6">
                    <button type="button" id="close-modal-btn"
                        class="flex-1 py-3 text-slate-600 font-bold hover:bg-slate-100 rounded-xl transition-colors">Cancelar</button>
                    <button type="submit"
                        class="flex-1 py-3 text-white bg-green-500 hover:bg-green-600 rounded-xl font-bold shadow-lg transition-colors">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Reporte -->
    <div id="report-modal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">Vista Previa del Reporte</h3>
                <button id="close-report-btn" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <div class="bg-slate-50 p-4 rounded-xl mb-6">
                <p class="text-sm text-slate-600 mb-2">Resumen General:</p>
                <div id="report-summary-content" class="space-y-2 text-sm font-medium"></div>
            </div>

            <button id="download-excel-btn"
                class="w-full py-4 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition-colors flex items-center justify-center gap-2 shadow-lg">
                <span>üì•</span> Descargar Excel para WhatsApp
            </button>
        </div>
    </div>

    <!-- Modal de Importaci√≥n (Confirmaci√≥n) -->
    <div id="import-preview-modal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl p-6 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-bold text-slate-800">Confirmar Importaci√≥n</h3>
                    <p class="text-xs text-slate-500">Revisa los datos. Usa <b>+/-</b> para corregir
                        si es Gasto o Pago.
                    </p>
                </div>
                <button id="close-import-btn" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <div
                class="bg-blue-50 p-4 rounded-xl mb-4 text-sm text-blue-800 flex flex-col sm:flex-row gap-4 items-center justify-between">
                <div class="w-full">
                    <span class="font-bold">Asignar a Tarjeta:</span>
                    <select id="import-target-card"
                        class="mt-1 block w-full bg-white border border-blue-200 text-slate-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Llenado con JS -->
                    </select>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto border border-slate-100 rounded-xl mb-4">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3">Fecha</th>
                            <th class="px-4 py-3">Descripci√≥n</th>
                            <th class="px-4 py-3 text-right">Monto</th>
                            <th class="px-4 py-3 text-center">Tipo</th>
                            <th class="px-4 py-3 text-center">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="import-preview-list" class="divide-y divide-slate-100">
                        <!-- Items -->
                    </tbody>
                </table>
            </div>

            <div class="flex gap-3">
                <button id="cancel-import-btn"
                    class="flex-1 py-3 text-slate-600 font-bold hover:bg-slate-100 rounded-xl transition-colors">Cancelar</button>
                <button id="confirm-import-btn"
                    class="flex-1 py-3 text-white bg-blue-600 hover:bg-blue-700 rounded-xl font-bold shadow-lg transition-colors">Guardar
                    Movimientos</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN Y DATOS ---
        const CARDS = {
            'banamex_roja': { name: 'Banamex D√©bito', type: 'debit', color: 'red' },
            'banamex_joy': { name: 'Banamex Joy', type: 'credit', color: 'pink', cutDay: 15, payTermDays: 20 },
            'banorte_debito': { name: 'Banorte D√©bito', type: 'debit', color: 'green' },
            'banorte_credito': {
                name: 'Banorte Cr√©dito', type: 'credit', color: 'emerald', cutDay: 10,
                payTermDays: 20
            },
            'bienestar': { name: 'Bienestar', type: 'debit', color: 'gray' },
            'invex': { name: 'Invex Aeropuerto', type: 'credit', color: 'amber', cutDay: 27, payTermDays: 20 }
        };

        const STORAGE_KEY = 'gastos_mama_v5';
        const BALANCE_KEY = 'saldos_mama_v5';

        let expenses = [];
        let initialBalances = {};
        let currentFilter = 'all';
        let currentDateFilter = 'all';
        let pendingImportData = [];
        let isListCollapsed = false;

        // --- UTILIDADES ---
        const formatMoney = (amount, currency = 'MXN') => {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: currency }).format(amount);
        };

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const [y, m, d] = dateString.split('-');
            const date = new Date(y, m - 1, d);
            return date.toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: '2-digit' });
        };

        const saveData = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
            localStorage.setItem(BALANCE_KEY, JSON.stringify(initialBalances));
        };

        const loadData = () => {
            try {
                const e = localStorage.getItem(STORAGE_KEY);
                const b = localStorage.getItem(BALANCE_KEY);
                if (e) expenses = JSON.parse(e);
                if (b) initialBalances = JSON.parse(b);
            } catch (err) { console.error("Error cargando datos", err); }
        };

        // --- RENDERIZADO ---

        const renderSummary = () => {
            const container = document.getElementById('summary-list');
            container.innerHTML = '';

            const summary = {};
            Object.keys(CARDS).forEach(key => {
                summary[key] = {
                    ...CARDS[key],
                    id: key,
                    totalDebt: 0,
                    monthlyPayment: 0,
                    balance: 0
                };
            });

            expenses.forEach(ex => {
                if (ex.paymentMethod === 'Tarjeta' && ex.cardInfo) {
                    const cardKey = Object.keys(CARDS).find(k => CARDS[k].name === ex.cardInfo.name);
                    if (cardKey) {
                        const card = summary[cardKey];
                        if (card.type === 'debit') {
                            card.balance -= ex.amount;
                        } else {
                            if (ex.amount < 0) { card.totalDebt += ex.amount; } else {
                                card.totalDebt += ex.amount; if
                                    (ex.installments > 0) {
                                    card.monthlyPayment += (ex.amount / ex.installments);
                                } else {
                                    card.monthlyPayment += ex.amount;
                                }
                            }
                        }
                    }
                }
            });

            Object.values(summary).forEach(card => {
                const initial = initialBalances[card.id] || 0;
                const el = document.createElement('div');
                el.className = `glass-panel p-4 rounded-2xl border-l-4 ${getBorderColor(card.color)} relative
                        overflow-hidden`;

                let content = '';

                if (card.type === 'debit') {
                    const finalBalance = initial - card.balance;
                    content = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-slate-700">${card.name}</h3>
                                <p class="text-xs text-slate-500 uppercase font-bold mt-1">Saldo Disponible</p>
                            </div>
                            <button onclick="adjustBalance('${card.id}')"
                                class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition-colors">
                                ‚öôÔ∏è Ajustar
                            </button>
                        </div>
                        <p class="text-2xl font-bold text-slate-800 mt-2">${formatMoney(finalBalance)}</p>
                        `;
                } else {
                    const totalDebt = initial + card.totalDebt;
                    const payments = expenses.filter(e => e.cardInfo && e.cardInfo.name === card.name && e.amount <
                        0).reduce((acc, curr) => acc + Math.abs(curr.amount), 0);

                    const finalPayNow = (initial + card.monthlyPayment) - payments;
                    const finalTotalDebt = totalDebt;

                    const today = new Date();
                    let cutDate = new Date(today.getFullYear(), today.getMonth(), card.cutDay);
                    let limitDate = new Date(cutDate);
                    limitDate.setDate(limitDate.getDate() + card.payTermDays);

                    if (today > limitDate) {
                        cutDate.setMonth(cutDate.getMonth() + 1);
                        limitDate = new Date(cutDate);
                        limitDate.setDate(limitDate.getDate() + card.payTermDays);
                    }

                    const limitDateStr = limitDate.toLocaleDateString('es-MX', {
                        day: 'numeric', month: 'short'
                    });

                    content = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-slate-700">${card.name}</h3>
                                    <p class="text-xs text-slate-500 uppercase font-bold mt-1">Pago del Mes</p>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="adjustBalance('${card.id}')"
                                        class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition-colors">‚öôÔ∏è</button>
                                    <button onclick="openPaymentModal('${card.id}')"
                                        class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded font-bold transition-colors">Pagar</button>
                                </div>
                            </div>

                            <p class="text-3xl font-bold text-slate-800 mt-1">${formatMoney(finalPayNow > 0 ?
                        finalPayNow : 0)}</p>
                            <p class="text-xs text-red-500 font-bold mb-3">Pagar antes del ${limitDateStr}</p>

                            <div class="mt-3 pt-3 border-t border-slate-100 flex justify-between items-end">
                                <div>
                                    <p class="text-xs text-slate-400">Deuda Total</p>
                                    <p class="text-sm font-bold text-orange-600">${formatMoney(finalTotalDebt)}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-slate-400">Corte: D√≠a ${card.cutDay}</p>
                                </div>
                            </div>
                            `;
                }
                el.innerHTML = content;
                container.appendChild(el);
            });
        };

        const renderDateFilter = () => {
            const dateSelect = document.getElementById('filter-date-select');
            const currentVal = dateSelect.value;

            // Guardar opciones est√°ticas
            dateSelect.innerHTML = '<option value="all">üìÖ Todo</option>';

            // Extraer meses √∫nicos
            const months = new Set();
            expenses.forEach(ex => {
                if (ex.date) {
                    months.add(ex.date.substring(0, 7)); // YYYY-MM
                }
            });

            // Ordenar descendente
            const sortedMonths = Array.from(months).sort().reverse();

            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct",
                "Nov", "Dic"];

            sortedMonths.forEach(m => {
                const [year, month] = m.split('-');
                const submitBtn = document.querySelector('#expense-form button[type="submit"]');
                submitBtn.textContent = "Guardar Movimiento";
                submitBtn.classList.add('glass-button');
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

                const cancelBtn = document.getElementById('cancel-edit-btn');
                if (cancelBtn) cancelBtn.classList.add('hidden');

                document.getElementById('date').value = new Date().toISOString().slice(0, 10);
                typeExpenseBtn.click();
                document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('bg-slate-800', 'text-white'));
                document.getElementById('card-options').classList.add('hidden');
            };

            document.getElementById('expense-form').onsubmit = (e) => {
                e.preventDefault();
                const amountVal = parseFloat(document.getElementById('amount').value);
                const isIncome = transactionTypeInput.value === 'income';
                const finalAmount = isIncome ? -Math.abs(amountVal) : Math.abs(amountVal);
                const editingId = document.getElementById('editing-expense-id').value;

                const expenseData = {
                    id: editingId ? parseFloat(editingId) : Date.now(),
                    description: document.getElementById('description').value,
                    amount: finalAmount,
                    currency: document.getElementById('currency').value,
                    paymentMethod: document.getElementById('payment-method').value,
                    cardInfo: document.getElementById('selected-card-info').value ? JSON.parse(document.getElementById('selected-card-info').value) : null,
                    installments: parseInt(document.getElementById('installments-months').value) || 0,
                    date: document.getElementById('date').value
                };

                if (!expenseData.paymentMethod) { alert("Selecciona un m√©todo de pago"); return; }
                if (expenseData.paymentMethod === 'Tarjeta' && !expenseData.cardInfo) {
                    alert("Selecciona una tarjeta"); return;
                }

                if (editingId) {
                    const index = expenses.findIndex(e => e.id === parseFloat(editingId));
                    if (index !== -1) {
                        expenses[index] = expenseData;
                        showFeedback("¬°Movimiento actualizado! ‚ú®");
                    }
                } else {
                    expenses.push(expenseData);
                    showFeedback("¬°Guardado con √©xito! üéâ");
                }

                saveData();
                updateUI();
                resetFormState();
            };

            window.deleteExpense = (id) => {
                if (confirm("¬øBorrar este movimiento?")) {
                    expenses = expenses.filter(e => e.id !== id);
                    saveData();
                    updateUI();
                }
            };

            window.adjustBalance = (cardId) => {
                const card = CARDS[cardId];
                const current = initialBalances[cardId] || 0;
                const promptMsg = card.type === 'credit'
                    ? `Define la DEUDA INICIAL de ${card.name} (antes de usar esta app): `
                    : `Define el SALDO INICIAL de ${card.name}: `;

                const val = prompt(promptMsg, current);
                if (val !== null) {
                    const num = parseFloat(val);
                    if (!isNaN(num)) {
                        initialBalances[cardId] = Math.abs(num);
                        saveData();
                        updateUI();
                    }
                }
            };

            window.openPaymentModal = (cardId) => {
                const modal = document.getElementById('payment-modal');
                document.getElementById('modal-card-id').value = cardId;
                document.getElementById('modal-card-name').textContent = CARDS[cardId].name;
                document.getElementById('payment-date').value = new Date().toISOString().slice(0, 10);
                modal.classList.remove('hidden');
            };

            document.getElementById('close-modal-btn').onclick = () => {
                document.getElementById('payment-modal').classList.add('hidden');
            };

            document.getElementById('payment-form').onsubmit = (e) => {
                e.preventDefault();
                const cardId = document.getElementById('modal-card-id').value;
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const date = document.getElementById('payment-date').value;

                if (!amount) return;

                const payment = {
                    id: Date.now(),
                    description: "PAGO A TARJETA",
                    amount: -Math.abs(amount),
                    currency: "MXN",
                    paymentMethod: "Tarjeta",
                    cardInfo: CARDS[cardId],
                    installments: 0,
                    date: date
                };

                expenses.push(payment);
                saveData();
                updateUI();
                document.getElementById('payment-modal').classList.add('hidden');
                showFeedback("Pago registrado üí∏");
            };

            // --- IMPORTAR EXCEL ---
            document.getElementById('import-excel-input').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const data = new Uint8Array(ev.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    pendingImportData = [];
                    json.forEach(row => {
                        const desc = row['Concepto'] || row['Descripci√≥n'] || row['Description'];
                        let amount = parseFloat(row['Monto'] || row['Amount'] || row['Importe']);
                        let dateRaw = row['Fecha'] || row['Date'];

                        if (dateRaw instanceof Date) {
                            dateRaw = dateRaw.toISOString().slice(0, 10);
                        }

                        const type = row['Tipo'] || '';
                        if (desc && !isNaN(amount)) {
                            if (type.toLowerCase().match(/abono|pago|dep√≥sito/)) {
                                amount = -Math.abs(amount);
                            }
                            pendingImportData.push({
                                description: desc,
                                amount: amount,
                                date: dateRaw
                            });
                        }
                    });
                    openImportPreview();
                };
                reader.readAsArrayBuffer(file);
            };

            // --- IMPORTAR PDF (SMART PARSING) ---
            document.getElementById('import-pdf-input').onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                showFeedback("Analizando PDF... ‚è≥");

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = "";

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        const strings = content.items.map(item => item.str);
                        fullText += strings.join(" | ") + "\n";
                    }

                    pendingImportData = parseBankText(fullText);

                    if (pendingImportData.length > 0) {
                        openImportPreview();
                    } else {
                        alert("No se detectaron movimientos claros en el PDF. Intenta copiar y pegar en Excel.");
                    }

                } catch (err) {
                    console.error(err);
                    alert("Error leyendo el PDF.");
                }
            };

            const parseBankText = (text) => {
                const lines = text.split('\n');
                const results = [];

                const dateRegex = /(\d{2}[\/\-]\w{3}|\d{2}\/\d{2}\/\d{2,4})/;
                const moneyRegex = /(\$?\d{1,3}(,\d{3})*(\.\d{2}))/;

                lines.forEach(line => {
                    const cleanLine = line.replace(/\|/g, ' ').trim();
                    const dateMatch = cleanLine.match(dateRegex);
                    const moneyMatch = cleanLine.match(moneyRegex);

                    if (dateMatch && moneyMatch) {
                        let dateStr = dateMatch[0];
                        let amountStr = moneyMatch[0].replace(/[$,]/g, '');
                        let amount = parseFloat(amountStr);

                        let desc = cleanLine.replace(dateMatch[0], '').replace(moneyMatch[0], '').trim();
                        desc = desc.replace(/\s+/g, ' ').substring(0, 40);

                        let formattedDate = new Date().toISOString().slice(0, 10);

                        const isPayment = /abono|pago|dep√≥sito|su pago|recepcion/i.test(cleanLine);
                        if (isPayment) {
                            amount = -Math.abs(amount);
                        }

                        if (desc.length > 3 && !isNaN(amount)) {
                            results.push({
                                description: desc,
                                amount: amount,
                                date: formattedDate
                            });
                        }
                    }
                });
                return results;
            };

            // --- IMPORT PREVIEW MODAL ---
            const importModal = document.getElementById('import-preview-modal');
            const importList = document.getElementById('import-preview-list');
            const targetCardSelect = document.getElementById('import-target-card');

            Object.keys(CARDS).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = CARDS[key].name;
                targetCardSelect.appendChild(opt);
            });

            const openImportPreview = () => {
                renderImportPreview();
                importModal.classList.remove('hidden');
            };

            const renderImportPreview = () => {
                importList.innerHTML = '';

                pendingImportData.forEach((item, index) => {
                    const isIncome = item.amount < 0;
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50";
                    tr.innerHTML = `
                < td class="px-4 py-2 whitespace-nowrap text-xs" > ${item.date}</td >
                    <td class="px-4 py-2 text-xs truncate max-w-[150px]" title="${item.description}">${item.description}</td>
                    <td class="px-4 py-2 text-right font-bold text-xs ${isIncome ? 'text-green-600' : 'text-slate-700'}">
                        ${formatMoney(Math.abs(item.amount))}
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="toggleImportItemSign(${index})"
                            class="text-xs font-bold px-2 py-1 rounded border ${isIncome ? 'bg-green-100 text-green-700 border-green-200' : 'bg-slate-100 text-slate-600 border-slate-200'} hover:scale-105 transition-transform">
                            ${isIncome ? 'Abono (+)' : 'Cargo (-)'}
                        </button>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="removeImportItem(${index})" class="text-red-400 hover:text-red-600 font-bold">&times;</button>
                    </td>
            `;
                    importList.appendChild(tr);
                });
            };

            window.toggleImportItemSign = (index) => {
                pendingImportData[index].amount = -pendingImportData[index].amount;
                renderImportPreview();
            };

            window.removeImportItem = (index) => {
                pendingImportData.splice(index, 1);
                renderImportPreview();
            };

            document.getElementById('confirm-import-btn').onclick = () => {
                const targetCardId = targetCardSelect.value;
                const cardInfo = CARDS[targetCardId];

                let count = 0;
                pendingImportData.forEach(item => {
                    expenses.push({
                        id: Date.now() + Math.random(),
                        description: item.description,
                        amount: item.amount,
                        currency: 'MXN',
                        paymentMethod: 'Tarjeta',
                        cardInfo: cardInfo,
                        installments: 0,
                        date: item.date
                    });
                    count++;
                });

                saveData();
                updateUI();
                importModal.classList.add('hidden');
                showFeedback(`¬°${count} movimientos importados a ${cardInfo.name} !`);
            };

            document.getElementById('close-import-btn').onclick = () => importModal.classList.add('hidden');
            document.getElementById('cancel-import-btn').onclick = () => importModal.classList.add('hidden');


            document.getElementById('download-template-btn').onclick = () => {
                const data = [
                    { "Fecha": "2025-11-01", "Concepto": "Ej: Supermercado", "Monto": 1500, "Tipo": "Cargo", "Tarjeta": "Banamex D√©bito", "MSI": 0 },
                    { "Fecha": "2025-11-05", "Concepto": "Pago Tarjeta", "Monto": 500, "Tipo": "Abono", "Tarjeta": "Banamex Joy", "MSI": 0 }
                ];
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Plantilla");
                XLSX.writeFile(wb, "Plantilla_Gastos.xlsx");
            };

            // --- REPORTE ---
            document.getElementById('generate-report-btn').onclick = () => {
                const modal = document.getElementById('report-modal');
                const content = document.getElementById('report-summary-content');

                const totalSpent = expenses.filter(e => e.amount > 0).reduce((a, b) => a + b.amount, 0);
                const totalIncome = expenses.filter(e => e.amount < 0).reduce((a, b) => a + Math.abs(b.amount), 0);

                content.innerHTML = `
                < div class="flex justify-between" ><span>Total Gastado:</span> <b>${formatMoney(totalSpent)}</b></div >
                <div class="flex justify-between text-green-600"><span>Total Ingresos/Pagos:</span> <b>${formatMoney(totalIncome)}</b></div>
                <div class="flex justify-between mt-2 pt-2 border-t border-slate-200"><span>Movimientos:</span> <b>${expenses.length}</b></div>
            `;

                modal.classList.remove('hidden');
            };

            document.getElementById('close-report-btn').onclick = () => {
                document.getElementById('report-modal').classList.add('hidden');
            };

            document.getElementById('download-excel-btn').onclick = () => {
                const data = expenses.map(e => ({
                    Fecha: e.date,
                    Concepto: e.description,
                    Monto: Math.abs(e.amount),
                    Tipo: e.amount < 0 ? 'Abono' : 'Cargo',
                    Tarjeta: e.cardInfo ? e.cardInfo.name : 'N/A',
                    MSI: e.installments || 0,
                    Pago_Mensual_Real: (e.installments > 0 ? (e.amount / e.installments) : e.amount).toFixed(2)
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reporte_Detallado");
                XLSX.writeFile(wb, "Reporte_Finanzas_Mama.xlsx");
                document.getElementById('report-modal').classList.add('hidden');
            };

            // --- HELPERS VISUALES ---
            const getBorderColor = (colorName) => {
                const map = {
                    'red': 'border-l-red-500',
                    'pink': 'border-l-pink-500',
                    'green': 'border-l-green-500',
                    'emerald': 'border-l-emerald-500',
                    'gray': 'border-l-gray-500',
                    'amber': 'border-l-amber-500'
                };
                return map[colorName] || 'border-l-blue-500';
            };

            const showFeedback = (msg) => {
                const el = document.getElementById('feedback-msg');
                el.textContent = msg;
                el.classList.remove('hidden');
                el.className = 'text-center text-sm font-bold mt-4 text-green-600 animate-bounce';
                setTimeout(() => el.classList.add('hidden'), 3000);
            };

            document.getElementById('reset-app-btn').onclick = () => {
                if (confirm("‚ö†Ô∏è ¬øEst√°s segura? Se borrar√°n todos los datos.")) {
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(BALANCE_KEY);
                    location.reload();
                }
            };

            // --- RESPALDO Y MIGRACI√ìN ---
            window.exportBackup = () => {
                const data = {
                    expenses: expenses,
                    initialBalances: initialBalances,
                    timestamp: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `finanzas_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showFeedback("¬°Respaldo descargado! üíæ");
            };

            window.restoreBackup = (input) => {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.expenses && data.initialBalances) {
                            if (confirm(`¬øRestaurar respaldo del ${new Date(data.timestamp).toLocaleDateString()}? Esto reemplazar√° los datos actuales.`)) {
                                expenses = data.expenses;
                                initialBalances = data.initialBalances;
                                saveData();
                                updateUI();
                                showFeedback("¬°Datos restaurados con √©xito! üöÄ");
                            }
                        } else {
                            alert("El archivo no parece ser un respaldo v√°lido.");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error al leer el archivo de respaldo.");
                    }
                    input.value = ''; // Reset input
                };
                reader.readAsText(file);
            };

            // Init
            document.getElementById('date').value = new Date().toISOString().slice(0, 10);
            loadData();
            updateUI();

            document.getElementById('filter-card-select').onchange = (e) => {
                currentFilter = e.target.value;
                updateUI();
            };

            document.getElementById('filter-date-select').onchange = (e) => {
                currentDateFilter = e.target.value;
                renderExpenses();
            };

    </script>
</body>

</html>