<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Fondo floral suave y semi-transparente */
            background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-48 0c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm76-15c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-28 8c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-48-50c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 50c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z" fill="%23f9a8d4" fill-opacity="0.1"/%3E%3C/svg%3E');
            background-color: #FFF7FA;
        }
        /* Estilos para que el input de fecha se vea mejor */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            filter: invert(0.8);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto max-w-2xl p-4 sm:p-6">

        <!-- Cabecera -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-pink-500">Mis Gastos</h1>
            <p class="text-gray-500 mt-2">Registra tus compras de forma fÃ¡cil y rÃ¡pida.</p>
        </header>

        <!-- Formulario para agregar gastos -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-700">Agregar Nuevo Gasto</h2>
            <form id="expense-form" class="space-y-4">
                <input type="hidden" id="editing-expense-id">
                <!-- DescripciÃ³n del gasto -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-600 mb-1">Â¿QuÃ© compraste?</label>
                    <input type="text" id="description" placeholder="Ej: CafÃ© en el aeropuerto" class="w-full px-4 py-3 text-lg border-gray-200 border rounded-xl focus:ring-pink-400 focus:border-pink-400" required>
                </div>

                <!-- Lugar del gasto (nuevo campo opcional) -->
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-600 mb-1">Â¿En dÃ³nde lo compraste? (Opcional)</label>
                    <input type="text" id="location" placeholder="Ej: Amazon, Mercado Libre, Chedraui" class="w-full px-4 py-3 text-lg border-gray-200 border rounded-xl focus:ring-pink-400 focus:border-pink-400">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Monto -->
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-600 mb-1">Monto</label>
                        <input type="number" id="amount" placeholder="150.00" step="0.01" class="w-full px-4 py-3 text-lg border-gray-200 border rounded-xl focus:ring-pink-400 focus:border-pink-400" required>
                    </div>
                    <!-- Moneda -->
                    <div>
                        <label for="currency" class="block text-sm font-medium text-gray-600 mb-1">Moneda</label>
                        <select id="currency" class="w-full px-4 py-3 text-lg bg-white border-gray-200 border rounded-xl focus:ring-pink-400 focus:border-pink-400">
                            <option value="MXN">Pesos (MXN)</option>
                            <option value="USD">DÃ³lares (USD)</option>
                        </select>
                    </div>
                </div>

                <!-- MÃ©todo de pago -->
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">MÃ©todo de pago</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" data-payment="Efectivo" class="payment-method-btn flex items-center justify-center gap-2 p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">
                            ðŸ’µ Efectivo
                        </button>
                        <button type="button" data-payment="Tarjeta" class="payment-method-btn flex items-center justify-center gap-2 p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">
                            ðŸ’³ Tarjeta
                        </button>
                        <button type="button" data-payment="Transferencia" class="payment-method-btn flex items-center justify-center gap-2 p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">
                            ðŸ“± Transfer
                        </button>
                    </div>
                    <input type="hidden" id="payment-method" required>
                </div>
                
                <!-- Opciones de tarjeta (ocultas por defecto) -->
                <div id="card-options" class="hidden space-y-4 pt-4 border-t border-gray-100">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">Â¿QuÃ© tarjeta usaste?</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" data-card-id="banamex_roja" class="card-btn p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">Banamex DÃ©bito</button>
                            <button type="button" data-card-id="banamex_simplicity" class="card-btn p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">Banamex Simplicity</button>
                            <button type="button" data-card-id="banorte_debito" class="card-btn p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">Banorte DÃ©bito</button>
                            <button type="button" data-card-id="banorte_credito" class="card-btn p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">Banorte CrÃ©dito</button>
                            <button type="button" data-card-id="bienestar" class="card-btn p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">Bienestar</button>
                            <button type="button" data-card-id="invex" class="card-btn p-3 text-lg border-2 border-gray-200 rounded-xl transition-all">Invex</button>
                        </div>
                        <input type="hidden" id="selected-card-info" required>
                    </div>
                    <div id="installments-section" class="hidden">
                        <label for="installments-months" class="block text-sm font-medium text-gray-600 mb-1">Meses S/ Intereses</label>
                        <select id="installments-months" class="w-full px-4 py-3 text-lg bg-white border-gray-200 border rounded-xl focus:ring-pink-400 focus:border-pink-400">
                            <option value="0">No aplica</option>
                            <option value="3">3 MSI</option>
                            <option value="6">6 MSI</option>
                            <option value="9">9 MSI</option>
                            <option value="12">12 MSI</option>
                            <option value="18">18 MSI</option>
                        </select>
                    </div>
                </div>

                <!-- Fecha -->
                 <div>
                    <label for="date" class="block text-sm font-medium text-gray-600 mb-1">Fecha de la compra</label>
                    <input type="date" id="date" class="w-full px-4 py-3 text-lg border-gray-200 border rounded-xl focus:ring-pink-400 focus:border-pink-400" required>
                </div>

                <!-- BotÃ³n de envÃ­o -->
                <button type="submit" class="w-full bg-pink-500 text-white font-bold text-lg py-4 rounded-xl hover:bg-pink-600 transition-colors shadow-md">
                    Agregar Gasto
                </button>
            </form>
        </div>

        <!-- Resumen de Gastos -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-xl font-bold mb-4 text-gray-700">Resumen de Gastos</h2>
            <div id="summary-list" class="space-y-3">
                <!-- El resumen se insertarÃ¡ aquÃ­ con JavaScript -->
            </div>
        </div>

        <!-- Lista de gastos -->
        <div id="expenses-list" class="space-y-4">
            <!-- Los gastos se insertarÃ¡n aquÃ­ con JavaScript -->
        </div>
        
        <!-- Mensaje cuando no hay gastos -->
        <div id="empty-state" class="hidden text-center py-10">
             <p class="text-gray-500">AÃºn no has registrado ningÃºn gasto.</p>
        </div>

        <!-- ReporterÃ­a -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mt-8 text-center">
            <h2 class="text-xl font-bold mb-4 text-gray-700">ReporterÃ­a</h2>
            <button id="generate-report-btn" class="w-full bg-teal-500 text-white font-bold text-lg py-4 rounded-xl hover:bg-teal-600 transition-colors shadow-md flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                </svg>
                Compartir Reporte
            </button>
            <p id="report-feedback" class="text-gray-600 mt-4 hidden p-3 rounded-lg border"></p>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DEL DOM ---
            const expenseForm = document.getElementById('expense-form');
            const editingExpenseIdInput = document.getElementById('editing-expense-id');
            const descriptionInput = document.getElementById('description');
            const locationInput = document.getElementById('location');
            const amountInput = document.getElementById('amount');
            const currencySelect = document.getElementById('currency');
            const dateInput = document.getElementById('date');
            const expensesList = document.getElementById('expenses-list');
            const emptyState = document.getElementById('empty-state');
            const summaryList = document.getElementById('summary-list');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const reportFeedback = document.getElementById('report-feedback');
            
            // Opciones de pago y tarjeta
            const paymentMethodBtns = document.querySelectorAll('.payment-method-btn');
            const paymentMethodInput = document.getElementById('payment-method');
            const cardOptions = document.getElementById('card-options');
            const cardBtns = document.querySelectorAll('.card-btn');
            const selectedCardInfoInput = document.getElementById('selected-card-info');
            const installmentsSection = document.getElementById('installments-section');
            const installmentsSelect = document.getElementById('installments-months');

            // DefiniciÃ³n de tarjetas
            const cards = {
                'banamex_roja': { name: 'Banamex DÃ©bito', type: 'debit', style: 'bg-red-100 border-red-500 text-red-600' },
                'banamex_simplicity': { name: 'Banamex Simplicity', type: 'credit', cutDay: 21, payDay: 10, style: 'bg-red-100 border-red-500 text-red-600' },
                'banorte_debito': { name: 'Banorte DÃ©bito', type: 'debit', style: 'bg-green-100 border-green-600 text-green-700' },
                'banorte_credito': { name: 'Banorte CrÃ©dito', type: 'credit', cutDay: 8, payTermDays: 40, style: 'bg-green-100 border-green-600 text-green-700' },
                'bienestar': { name: 'Bienestar', type: 'debit', style: 'bg-gray-200 border-gray-600 text-gray-700' },
                'invex': { name: 'Invex Aeropuerto', type: 'credit', cutDay: 26, payDay: 16, style: 'bg-yellow-100 border-yellow-500 text-yellow-600' }
            };

            // --- ESTADO DE LA APLICACIÃ“N ---
            let expenses = JSON.parse(localStorage.getItem('expenses')) || [];

            // --- LÃ“GICA ---

            const renderSummary = () => {
                const summary = {};
                expenses.forEach(expense => {
                    if (expense.paymentMethod === 'Tarjeta' && expense.cardInfo && expense.cardInfo.name) {
                        const cardId = Object.keys(cards).find(id => cards[id].name === expense.cardInfo.name);
                        const currency = expense.currency;
                        if (cardId) {
                            const summaryKey = `${cardId}_${currency}`;
                            if (!summary[summaryKey]) {
                                summary[summaryKey] = { total: 0, cardName: cards[cardId].name, currency: currency, style: cards[cardId].style };
                            }
                            let amountToAdd = expense.amount;
                            if (expense.cardInfo.type === 'credit' && expense.installments > 0) {
                                amountToAdd = expense.amount / expense.installments;
                            }
                            summary[summaryKey].total += amountToAdd;
                        }
                    }
                });
                summaryList.innerHTML = ''; 
                const displayOrder = ['banamex_simplicity', 'banorte_credito', 'invex', 'banamex_roja', 'banorte_debito', 'bienestar'];
                let hasSummaryData = false;
                displayOrder.forEach(cardId => {
                    ['MXN', 'USD'].forEach(currency => {
                        const summaryKey = `${cardId}_${currency}`;
                        if (summary[summaryKey] && summary[summaryKey].total > 0) {
                            hasSummaryData = true;
                            const data = summary[summaryKey];
                            const summaryElement = document.createElement('div');
                            summaryElement.className = 'flex justify-between items-center p-3 rounded-lg border-l-4';
                            const borderColorClass = data.style.split(' ').find(c => c.startsWith('border-')) || 'border-gray-300';
                            const textColorClass = data.style.split(' ').find(c => c.startsWith('text-')) || 'text-gray-800';
                            summaryElement.classList.add(borderColorClass);
                            summaryElement.innerHTML = `<span class="font-semibold ${textColorClass}">${data.cardName} (${currency})</span><span class="font-bold text-lg ${textColorClass}">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: data.currency }).format(data.total)}</span>`;
                            summaryList.appendChild(summaryElement);
                        }
                    });
                });
                if (!hasSummaryData) {
                    summaryList.innerHTML = '<p class="text-center text-gray-500">No hay gastos con tarjeta para resumir.</p>';
                }
            };

            const renderExpenses = () => {
                expensesList.innerHTML = '';
                if (expenses.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    const sortedExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                    sortedExpenses.forEach(expense => {
                        const expenseElement = document.createElement('div');
                        expenseElement.className = 'bg-white p-5 rounded-xl shadow-md flex items-start justify-between transition-transform transform hover:scale-105';
                        let paymentInfo = (expense.paymentMethod === 'Tarjeta') 
                            ? `<span class="text-sm text-gray-500 block">${(expense.cardInfo && expense.cardInfo.name) ? expense.cardInfo.name : 'Tarjeta'} ${expense.installments > 0 ? `| ${expense.installments} MSI` : ''}</span>`
                            : `<span class="text-sm text-gray-500 block">${expense.paymentMethod}</span>`;
                        let locationInfo = (expense.location && expense.location.trim() !== '') ? `<p class="text-sm text-gray-500 -mt-1 mb-2">${expense.location}</p>` : '';
                        expenseElement.innerHTML = `
                            <div class="flex-grow">
                                <div class="flex items-baseline gap-2">
                                     <p class="font-bold text-lg text-gray-800">${expense.description}</p>
                                     <p class="text-xs text-gray-400">${new Date(expense.date).toLocaleDateString('es-MX', { year: 'numeric', month: 'short', day: 'numeric' })}</p>
                                </div>
                                ${locationInfo}
                                <p class="text-xl font-semibold text-pink-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: expense.currency }).format(expense.amount)}</p>
                                ${paymentInfo}
                            </div>
                            <div class="flex-shrink-0 flex items-center">
                                <button data-id="${expense.id}" class="edit-btn text-gray-400 hover:text-blue-500 transition-colors p-2 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" />
                                    </svg>
                                </button>
                                <button data-id="${expense.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        `;
                        expensesList.appendChild(expenseElement);
                    });
                }
                renderSummary(); 
            };

            const saveExpenses = () => localStorage.setItem('expenses', JSON.stringify(expenses));

            const handleEditExpense = (id) => {
                const expense = expenses.find(e => e.id === id);
                if (!expense) return;
                editingExpenseIdInput.value = expense.id;
                descriptionInput.value = expense.description;
                locationInput.value = expense.location || '';
                amountInput.value = expense.amount;
                currencySelect.value = expense.currency;
                dateInput.value = expense.date;
                paymentMethodBtns.forEach(btn => { if (btn.dataset.payment === expense.paymentMethod) btn.click(); });
                if (expense.paymentMethod === 'Tarjeta' && expense.cardInfo) {
                    const cardId = Object.keys(cards).find(key => cards[key].name === expense.cardInfo.name);
                    cardBtns.forEach(btn => { if (btn.dataset.cardId === cardId) btn.click(); });
                    installmentsSelect.value = expense.installments;
                }
                expenseForm.querySelector('button[type="submit"]').textContent = 'Modificar Gasto';
                expenseForm.scrollIntoView({ behavior: 'smooth' });
            };

            const calculatePaymentDate = (expense) => {
                if (!expense.cardInfo || expense.cardInfo.type !== 'credit') return 'N/A';
                
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                
                const [year, month, day] = expense.date.split('-').map(Number);
                const purchaseDate = new Date(year, month - 1, day);
                const { cutDay, payDay, payTermDays } = expense.cardInfo;

                let cutOffYear = purchaseDate.getFullYear();
                let cutOffMonth = purchaseDate.getMonth();

                if (purchaseDate.getDate() > cutDay) {
                    cutOffMonth += 1;
                    if (cutOffMonth > 11) {
                        cutOffMonth = 0;
                        cutOffYear += 1;
                    }
                }
                const cutOffDate = new Date(cutOffYear, cutOffMonth, cutDay);
                
                let paymentDate;
                if (payDay) {
                    let paymentYear = cutOffYear;
                    let paymentMonth = cutOffMonth + 1;
                    if (paymentMonth > 11) {
                        paymentMonth = 0;
                        paymentYear += 1;
                    }
                    paymentDate = new Date(paymentYear, paymentMonth, payDay);
                } else if (payTermDays) {
                    paymentDate = new Date(cutOffDate);
                    paymentDate.setDate(cutOffDate.getDate() + payTermDays);
                }

                if (!paymentDate) return 'Error';

                return `${paymentDate.getDate()} ${monthNames[paymentDate.getMonth()]}`;
            };

            // --- MANEJO DE EVENTOS ---
            paymentMethodBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    paymentMethodBtns.forEach(b => b.classList.remove('bg-pink-500', 'text-white', 'border-pink-500'));
                    btn.classList.add('bg-pink-500', 'text-white', 'border-pink-500');
                    paymentMethodInput.value = btn.dataset.payment;
                    cardBtns.forEach(cb => Object.values(cards).forEach(c => cb.classList.remove(...c.style.split(' '))));
                    selectedCardInfoInput.value = '';
                    installmentsSection.classList.add('hidden');
                    if (btn.dataset.payment === 'Tarjeta') {
                        cardOptions.classList.remove('hidden');
                        selectedCardInfoInput.required = true;
                    } else {
                        cardOptions.classList.add('hidden');
                        selectedCardInfoInput.required = false;
                    }
                });
            });

            cardBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const cardId = btn.dataset.cardId;
                    const cardData = cards[cardId];
                    cardBtns.forEach(cb => Object.values(cards).forEach(c => cb.classList.remove(...c.style.split(' '))));
                    btn.classList.add(...cardData.style.split(' '));
                    selectedCardInfoInput.value = JSON.stringify(cardData);
                    if (cardData.type === 'credit') {
                        installmentsSection.classList.remove('hidden');
                    } else {
                        installmentsSection.classList.add('hidden');
                        installmentsSelect.value = '0';
                    }
                });
            });

            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!paymentMethodInput.value) { alert('Por favor, selecciona un mÃ©todo de pago.'); return; }
                if (paymentMethodInput.value === 'Tarjeta' && !selectedCardInfoInput.value) { alert('Por favor, selecciona una tarjeta.'); return; }
                const editingId = parseInt(editingExpenseIdInput.value);
                const expenseData = {
                    description: descriptionInput.value,
                    location: locationInput.value,
                    amount: parseFloat(amountInput.value),
                    currency: currencySelect.value,
                    paymentMethod: paymentMethodInput.value,
                    cardInfo: selectedCardInfoInput.value ? JSON.parse(selectedCardInfoInput.value) : null,
                    installments: parseInt(installmentsSelect.value),
                    date: dateInput.value,
                };
                if (editingId) {
                    const index = expenses.findIndex(e => e.id === editingId);
                    if (index > -1) expenses[index] = { ...expenses[index], ...expenseData };
                } else {
                    expenses.push({ id: Date.now(), ...expenseData });
                }
                saveExpenses();
                renderExpenses();
                expenseForm.reset();
                editingExpenseIdInput.value = '';
                expenseForm.querySelector('button[type="submit"]').textContent = 'Agregar Gasto';
                paymentMethodInput.value = '';
                selectedCardInfoInput.value = '';
                paymentMethodBtns.forEach(b => b.classList.remove('bg-pink-500', 'text-white', 'border-pink-500'));
                cardBtns.forEach(cb => Object.values(cards).forEach(c => cb.classList.remove(...c.style.split(' '))));
                cardOptions.classList.add('hidden');
                installmentsSection.classList.add('hidden');
                dateInput.value = new Date().toISOString().split('T')[0];
            });

            expensesList.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    handleEditExpense(parseInt(editBtn.dataset.id));
                    return;
                }
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    expenses = expenses.filter(expense => expense.id !== parseInt(deleteBtn.dataset.id));
                    saveExpenses();
                    renderExpenses();
                }
            });

            generateReportBtn.addEventListener('click', async () => {
                if (expenses.length === 0) { alert('No hay gastos para generar un reporte.'); return; }
                reportFeedback.classList.add('hidden');
                reportFeedback.textContent = ''; // Clear previous messages
                reportFeedback.classList.remove('bg-green-50', 'border-green-200', 'bg-yellow-50', 'border-yellow-200', 'bg-blue-50', 'border-blue-200');
                const reportData = expenses.map(e => {
                    const monthlyAmount = (e.installments > 0) ? e.amount / e.installments : e.amount;
                    return {
                        'Fecha de Compra': new Date(e.date).toLocaleDateString('es-MX'),
                        'DescripciÃ³n': e.description,
                        'Lugar de Compra': e.location || '',
                        'Tarjeta / MÃ©todo': e.cardInfo ? e.cardInfo.name : e.paymentMethod,
                        'Monto Total': e.amount,
                        'Moneda': e.currency,
                        'Aplica MSI': e.installments > 0 ? 'SÃ­' : 'No',
                        'Plazo (Meses)': e.installments,
                        'Monto Mensual': monthlyAmount,
                        'A pagar': calculatePaymentDate(e)
                    };
                });
                const worksheet = XLSX.utils.json_to_sheet(reportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Gastos");
                try {
                    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const file = new File([blob], 'Reporte_Gastos_Mama.xlsx', { type: blob.type });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({ title: 'Reporte de Gastos', text: 'Hola! Te envÃ­o el reporte de gastos de mamÃ¡.', files: [file] });
                        reportFeedback.textContent = 'Â¡Reporte compartido con Ã©xito!';
                        reportFeedback.classList.add('bg-green-50', 'border-green-200');
                    } else {
                        XLSX.writeFile(workbook, "Reporte_Gastos_Mama.xlsx");
                        reportFeedback.textContent = 'Reporte descargado. Ahora puedes adjuntarlo manually.';
                        reportFeedback.classList.add('bg-blue-50', 'border-blue-200');
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        reportFeedback.textContent = 'El envÃ­o fue cancelado o hubo un error.';
                        reportFeedback.classList.add('bg-yellow-50', 'border-yellow-200');
                    }
                } finally {
                    if (reportFeedback.textContent) reportFeedback.classList.remove('hidden');
                }
            });

            // --- INICIALIZACIÃ“N ---
            dateInput.value = new Date().toISOString().split('T')[0];
            renderExpenses();
        });
    </script>
</body>
</html>

